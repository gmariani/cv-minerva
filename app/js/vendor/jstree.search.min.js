!function(e){"use strict";"function"==typeof define&&define.amd?define("jstree.search",["jquery","jstree"],e):"object"==typeof exports?e(require("jquery"),require("jstree")):e(jQuery,jQuery.jstree)}(function(e,t,s){"use strict";e.jstree.plugins.search||(e.jstree.defaults.search={ajax:!1,fuzzy:!1,case_sensitive:!1,show_only_matches:!1,close_opened_onclear:!0,search_leaves_only:!1,search_callback:!1},e.jstree.plugins.search=function(t,a){this.bind=function(){a.bind.call(this),this._data.search.str="",this._data.search.dom=e(),this._data.search.res=[],this._data.search.opn=[],this._data.search.som=!1,this.element.on("before_open.jstree",e.proxy(function(){var t,s,a=this._data.search.res,r=[],i=e();if(a&&a.length&&(this._data.search.dom=e(this.element[0].querySelectorAll("#"+e.map(a,function(t){return-1!=="0123456789".indexOf(t[0])?"\\3"+t[0]+" "+t.substr(1).replace(e.jstree.idregex,"\\$&"):t.replace(e.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.dom.children(".jstree-anchor").addClass("jstree-search"),this._data.search.som&&this._data.search.res.length)){for(t=0,s=a.length;s>t;t++)r=r.concat(this.get_node(a[t]).parents);r=e.vakata.array_remove_item(e.vakata.array_unique(r),"#"),i=r.length?e(this.element[0].querySelectorAll("#"+e.map(r,function(t){return-1!=="0123456789".indexOf(t[0])?"\\3"+t[0]+" "+t.substr(1).replace(e.jstree.idregex,"\\$&"):t.replace(e.jstree.idregex,"\\$&")}).join(", #"))):e(),this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last"),i=i.add(this._data.search.dom),i.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){e(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")})}},this)).on("search.jstree",e.proxy(function(t,s){this._data.search.som&&s.nodes.length&&(this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last"),s.nodes.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){e(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")}))},this)).on("clear_search.jstree",e.proxy(function(e,t){this._data.search.som&&t.nodes.length&&this.element.find(".jstree-node").css("display","").filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last")},this))},this.search=function(t,a,r){if(t===!1||""===e.trim(t.toString()))return this.clear_search();t=t.toString();var i=this.settings.search,n=i.ajax?i.ajax:!1,h=null,c=[],o=[];return this._data.search.res.length&&this.clear_search(),r===s&&(r=i.show_only_matches),a||n===!1?(this._data.search.str=t,this._data.search.dom=e(),this._data.search.res=[],this._data.search.opn=[],this._data.search.som=r,h=new e.vakata.search(t,!0,{caseSensitive:i.case_sensitive,fuzzy:i.fuzzy}),e.each(this._model.data,function(e,s){s.text&&(i.search_callback&&i.search_callback.call(this,t,s)||!i.search_callback&&h.search(s.text).isMatch)&&(!i.search_leaves_only||s.state.loaded&&0===s.children.length)&&(c.push(e),o=o.concat(s.parents))}),c.length&&(o=e.vakata.array_unique(o),this._search_open(o),this._data.search.dom=e(this.element[0].querySelectorAll("#"+e.map(c,function(t){return-1!=="0123456789".indexOf(t[0])?"\\3"+t[0]+" "+t.substr(1).replace(e.jstree.idregex,"\\$&"):t.replace(e.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.res=c,this._data.search.dom.children(".jstree-anchor").addClass("jstree-search")),void this.trigger("search",{nodes:this._data.search.dom,str:t,res:this._data.search.res,show_only_matches:r})):e.isFunction(n)?n.call(this,t,e.proxy(function(s){s&&s.d&&(s=s.d),this._load_nodes(e.isArray(s)?e.vakata.array_unique(s):[],function(){this.search(t,!0,r)},!0)},this)):(n=e.extend({},n),n.data||(n.data={}),n.data.str=t,e.ajax(n).fail(e.proxy(function(){this._data.core.last_error={error:"ajax",plugin:"search",id:"search_01",reason:"Could not load search parents",data:JSON.stringify(n)},this.settings.core.error.call(this,this._data.core.last_error)},this)).done(e.proxy(function(s){s&&s.d&&(s=s.d),this._load_nodes(e.isArray(s)?e.vakata.array_unique(s):[],function(){this.search(t,!0,r)},!0)},this)))},this.clear_search=function(){this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search"),this.settings.search.close_opened_onclear&&this.close_node(this._data.search.opn,0),this.trigger("clear_search",{nodes:this._data.search.dom,str:this._data.search.str,res:this._data.search.res}),this._data.search.str="",this._data.search.res=[],this._data.search.opn=[],this._data.search.dom=e()},this._search_open=function(t){var s=this;e.each(t.concat([]),function(a,r){if("#"===r)return!0;try{r=e("#"+r.replace(e.jstree.idregex,"\\$&"),s.element)}catch(i){}r&&r.length&&s.is_closed(r)&&(s._data.search.opn.push(r[0].id),s.open_node(r,function(){s._search_open(t)},0))})}},function(e){e.vakata.search=function(e,t,s){s=s||{},s.fuzzy!==!1&&(s.fuzzy=!0),e=s.caseSensitive?e:e.toLowerCase();var a,r,i,n,h=s.location||0,c=s.distance||100,o=s.threshold||.6,d=e.length;return d>32&&(s.fuzzy=!1),s.fuzzy&&(a=1<<d-1,r=function(){var t={},s=0;for(s=0;d>s;s++)t[e.charAt(s)]=0;for(s=0;d>s;s++)t[e.charAt(s)]|=1<<d-s-1;return t}(),i=function(e,t){var s=e/d,a=Math.abs(h-t);return c?s+a/c:a?1:s}),n=function(t){if(t=s.caseSensitive?t:t.toLowerCase(),e===t||-1!==t.indexOf(e))return{isMatch:!0,score:0};if(!s.fuzzy)return{isMatch:!1,score:1};var n,c,l,u,_,f,j,m,p,y=t.length,g=o,x=t.indexOf(e,h),v=d+y,b=1,z=[];for(-1!==x&&(g=Math.min(i(0,x),g),x=t.lastIndexOf(e,h+d),-1!==x&&(g=Math.min(i(0,x),g))),x=-1,n=0;d>n;n++){for(l=0,u=v;u>l;)i(n,h+u)<=g?l=u:v=u,u=Math.floor((v-l)/2+l);for(v=u,f=Math.max(1,h-u+1),j=Math.min(h+u,y)+d,m=new Array(j+2),m[j+1]=(1<<n)-1,c=j;c>=f;c--)if(p=r[t.charAt(c-1)],m[c]=0===n?(m[c+1]<<1|1)&p:(m[c+1]<<1|1)&p|((_[c+1]|_[c])<<1|1)|_[c+1],m[c]&a&&(b=i(n,c-1),g>=b)){if(g=b,x=c-1,z.push(x),!(x>h))break;f=Math.max(1,2*h-x)}if(i(n+1,h)>g)break;_=m}return{isMatch:x>=0,score:b}},t===!0?{search:n}:n(t)}}(e))});